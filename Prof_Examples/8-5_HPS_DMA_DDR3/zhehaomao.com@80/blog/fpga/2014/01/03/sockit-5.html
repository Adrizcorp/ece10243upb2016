<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>

  Exploring the Arrow SoCKit Part V - Computing MD5 Checksums on the FPGA

</title>

<link rel="stylesheet" type="text/css" href="../../../../../css/main.css"/default.htm>
<link rel="stylesheet" type="text/css" href="../../../../../css/syntax.css"/default.htm>
<link href="../../../../../atom.xml" type="application/atom+xml" rel="alternate"/>

</head>
<body>
<div id="container">

<div id="header">
<a id="toplink" href="../../../../../"/default.htm>Howard Mao</a>
</div> <!--header-->

<div id="main">
  
    <h1>Exploring the Arrow SoCKit Part V - Computing MD5 Checksums on the FPGA</h1>
  
  <p>In parts I-IV of this tutorial series, we looked at how to create a simple
flashing LED module on the FPGA and control it via software. Now, we will see
how to use the FPGA to perform computation. To do this, we will take a
non-trivial algorithm and implement it in Verilog. I have chosen to use the
MD5 checksum algorithm as the example, since it is relatively easy to
implement in hardware. Once we have a hardware unit that can compute MD5 sums,
we can instantiate multiple instances of it and hook them up to the CPU to
perform brute-force MD5 hash reversal.</p>

<p>I’ll be breaking up the development of the MD5 cracker across several blog
posts, just as I did with the flashing LED example. This post will focus on
implementing the algorithm. Later posts will discuss verification through
simulation and control via software.</p>

<h2 id="the-algorithm">The Algorithm</h2>

<p>Here is the pseudocode for the MD5 algorithm, taken from Wikipedia.</p>

<div class="highlight"><pre><code class="language-pascal" data-lang="pascal"><span class="c1">//Note: All variables are unsigned 32 bit and wrap modulo 2^32 when calculating</span>
<span class="k">var</span> <span class="nb">int</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="n">s</span><span class="o">,</span> <span class="n">K</span>

<span class="c1">//s specifies the per-round shift amounts</span>
<span class="n">s</span><span class="p">[</span> <span class="mi">0</span><span class="o">..</span><span class="mi">15</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 7, 12, 17, 22,  7, 12, 17, 22,  7, 12, 17, 22,  7, 12, 17, 22}</span>
<span class="n">s</span><span class="p">[</span><span class="mi">16</span><span class="o">..</span><span class="mi">31</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 5,  9, 14, 20,  5,  9, 14, 20,  5,  9, 14, 20,  5,  9, 14, 20}</span>
<span class="n">s</span><span class="p">[</span><span class="mi">32</span><span class="o">..</span><span class="mi">47</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 4, 11, 16, 23,  4, 11, 16, 23,  4, 11, 16, 23,  4, 11, 16, 23}</span>
<span class="n">s</span><span class="p">[</span><span class="mi">48</span><span class="o">..</span><span class="mi">63</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 6, 10, 15, 21,  6, 10, 15, 21,  6, 10, 15, 21,  6, 10, 15, 21}</span>

<span class="c1">//Use binary integer part of the sines of integers (Radians) as constants:</span>
<span class="k">for</span> <span class="n">i</span> <span class="n">from</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">63</span>
    <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:=</span> <span class="nb">floor</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">sin</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="err">×</span> <span class="p">(</span><span class="mi">2</span> <span class="n">pow</span> <span class="mi">32</span><span class="p">))</span>
<span class="k">end</span> <span class="k">for</span>
<span class="c1">//(Or just use the following table):</span>
<span class="n">K</span><span class="p">[</span> <span class="mi">0</span><span class="o">..</span> <span class="mi">3</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xd76aa478, 0xe8c7b756, 0x242070db, 0xc1bdceee }</span>
<span class="n">K</span><span class="p">[</span> <span class="mi">4</span><span class="o">..</span> <span class="mi">7</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xf57c0faf, 0x4787c62a, 0xa8304613, 0xfd469501 }</span>
<span class="n">K</span><span class="p">[</span> <span class="mi">8</span><span class="o">..</span><span class="mi">11</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0x698098d8, 0x8b44f7af, 0xffff5bb1, 0x895cd7be }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">12</span><span class="o">..</span><span class="mi">15</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0x6b901122, 0xfd987193, 0xa679438e, 0x49b40821 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">16</span><span class="o">..</span><span class="mi">19</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xf61e2562, 0xc040b340, 0x265e5a51, 0xe9b6c7aa }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">20</span><span class="o">..</span><span class="mi">23</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xd62f105d, 0x02441453, 0xd8a1e681, 0xe7d3fbc8 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">24</span><span class="o">..</span><span class="mi">27</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0x21e1cde6, 0xc33707d6, 0xf4d50d87, 0x455a14ed }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">28</span><span class="o">..</span><span class="mi">31</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xa9e3e905, 0xfcefa3f8, 0x676f02d9, 0x8d2a4c8a }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">32</span><span class="o">..</span><span class="mi">35</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xfffa3942, 0x8771f681, 0x6d9d6122, 0xfde5380c }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">36</span><span class="o">..</span><span class="mi">39</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xa4beea44, 0x4bdecfa9, 0xf6bb4b60, 0xbebfbc70 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">40</span><span class="o">..</span><span class="mi">43</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0x289b7ec6, 0xeaa127fa, 0xd4ef3085, 0x04881d05 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">44</span><span class="o">..</span><span class="mi">47</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xd9d4d039, 0xe6db99e5, 0x1fa27cf8, 0xc4ac5665 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">48</span><span class="o">..</span><span class="mi">51</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xf4292244, 0x432aff97, 0xab9423a7, 0xfc93a039 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">52</span><span class="o">..</span><span class="mi">55</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0x655b59c3, 0x8f0ccc92, 0xffeff47d, 0x85845dd1 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">56</span><span class="o">..</span><span class="mi">59</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0x6fa87e4f, 0xfe2ce6e0, 0xa3014314, 0x4e0811a1 }</span>
<span class="n">K</span><span class="p">[</span><span class="mi">60</span><span class="o">..</span><span class="mi">63</span><span class="p">]</span> <span class="o">:=</span> <span class="cm">{ 0xf7537e82, 0xbd3af235, 0x2ad7d2bb, 0xeb86d391 }</span>

<span class="c1">//Initialize variables:</span>
<span class="k">var</span> <span class="nb">int</span> <span class="n">a0</span> <span class="o">:=</span> <span class="mi">0</span><span class="n">x67452301</span>   <span class="c1">//A</span>
<span class="k">var</span> <span class="nb">int</span> <span class="n">b0</span> <span class="o">:=</span> <span class="mi">0</span><span class="n">xefcdab89</span>   <span class="c1">//B</span>
<span class="k">var</span> <span class="nb">int</span> <span class="n">c0</span> <span class="o">:=</span> <span class="mi">0</span><span class="n">x98badcfe</span>   <span class="c1">//C</span>
<span class="k">var</span> <span class="nb">int</span> <span class="n">d0</span> <span class="o">:=</span> <span class="mi">0</span><span class="n">x10325476</span>   <span class="c1">//D</span>

<span class="c1">//Pre-processing: adding a single 1 bit</span>
<span class="nb">append</span> <span class="mi">1</span> <span class="n">bit</span> <span class="k">to</span> <span class="n">message</span>
<span class="c1">// Notice: the input bytes are considered as bit strings,</span>
<span class="c1">// where the first bit is the most significant bit of the byte.</span>


<span class="c1">//Pre-processing: padding with zeros</span>
<span class="nb">append</span> <span class="mi">0</span> <span class="n">bit</span> <span class="k">until</span> <span class="n">message</span> <span class="nb">length</span> <span class="k">in</span> <span class="n">bit</span> <span class="o">==</span> <span class="mi">448</span> <span class="p">(</span><span class="k">mod</span> <span class="mi">512</span><span class="p">)</span>
<span class="nb">append</span> <span class="nb">length</span> <span class="k">mod</span> <span class="p">(</span><span class="mi">2</span> <span class="n">pow</span> <span class="mi">64</span><span class="p">)</span> <span class="k">to</span> <span class="n">message</span>


<span class="c1">//Process the message in successive 512-bit chunks:</span>
<span class="k">for</span> <span class="n">each</span> <span class="mi">512</span><span class="o">-</span><span class="n">bit</span> <span class="n">chunk</span> <span class="k">of</span> <span class="n">message</span>
    <span class="k">break</span> <span class="n">chunk</span> <span class="n">into</span> <span class="n">sixteen</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">words</span> <span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">,</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">15</span>
<span class="c1">//Initialize hash value for this chunk:</span>
    <span class="k">var</span> <span class="nb">int</span> <span class="n">A</span> <span class="o">:=</span> <span class="n">a0</span>
    <span class="k">var</span> <span class="nb">int</span> <span class="n">B</span> <span class="o">:=</span> <span class="n">b0</span>
    <span class="k">var</span> <span class="nb">int</span> <span class="n">C</span> <span class="o">:=</span> <span class="n">c0</span>
    <span class="k">var</span> <span class="nb">int</span> <span class="n">D</span> <span class="o">:=</span> <span class="n">d0</span>
<span class="c1">//Main loop:</span>
    <span class="k">for</span> <span class="n">i</span> <span class="n">from</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">63</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">15</span> <span class="k">then</span>
            <span class="n">F</span> <span class="o">:=</span> <span class="p">(</span><span class="n">B</span> <span class="k">and</span> <span class="n">C</span><span class="p">)</span> <span class="k">or</span> <span class="p">((</span><span class="k">not</span> <span class="n">B</span><span class="p">)</span> <span class="k">and</span> <span class="n">D</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">:=</span> <span class="n">i</span>
        <span class="k">else</span> <span class="k">if</span> <span class="mi">16</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">31</span>
            <span class="n">F</span> <span class="o">:=</span> <span class="p">(</span><span class="n">D</span> <span class="k">and</span> <span class="n">B</span><span class="p">)</span> <span class="k">or</span> <span class="p">((</span><span class="k">not</span> <span class="n">D</span><span class="p">)</span> <span class="k">and</span> <span class="n">C</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">:=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">mod</span> <span class="mi">16</span>
        <span class="k">else</span> <span class="k">if</span> <span class="mi">32</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">47</span>
            <span class="n">F</span> <span class="o">:=</span> <span class="n">B</span> <span class="k">xor</span> <span class="n">C</span> <span class="k">xor</span> <span class="n">D</span>
            <span class="n">g</span> <span class="o">:=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="k">mod</span> <span class="mi">16</span>
        <span class="k">else</span> <span class="k">if</span> <span class="mi">48</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">63</span>
            <span class="n">F</span> <span class="o">:=</span> <span class="n">C</span> <span class="k">xor</span> <span class="p">(</span><span class="n">B</span> <span class="k">or</span> <span class="p">(</span><span class="k">not</span> <span class="n">D</span><span class="p">))</span>
            <span class="n">g</span> <span class="o">:=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="k">mod</span> <span class="mi">16</span>
        <span class="n">dTemp</span> <span class="o">:=</span> <span class="n">D</span>
        <span class="n">D</span> <span class="o">:=</span> <span class="n">C</span>
        <span class="n">C</span> <span class="o">:=</span> <span class="n">B</span>
        <span class="n">B</span> <span class="o">:=</span> <span class="n">B</span> <span class="o">+</span> <span class="n">leftrotate</span><span class="p">((</span><span class="n">A</span> <span class="o">+</span> <span class="n">F</span> <span class="o">+</span> <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">M</span><span class="p">[</span><span class="n">g</span><span class="p">])</span><span class="o">,</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">A</span> <span class="o">:=</span> <span class="n">dTemp</span>
    <span class="k">end</span> <span class="k">for</span>
<span class="c1">//Add this chunk&#39;s hash to result so far:</span>
    <span class="n">a0</span> <span class="o">:=</span> <span class="n">a0</span> <span class="o">+</span> <span class="n">A</span>
    <span class="n">b0</span> <span class="o">:=</span> <span class="n">b0</span> <span class="o">+</span> <span class="n">B</span>
    <span class="n">c0</span> <span class="o">:=</span> <span class="n">c0</span> <span class="o">+</span> <span class="n">C</span>
    <span class="n">d0</span> <span class="o">:=</span> <span class="n">d0</span> <span class="o">+</span> <span class="n">D</span>
<span class="k">end</span> <span class="k">for</span>

<span class="k">var</span> <span class="kt">char</span> <span class="n">digest</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">:=</span> <span class="n">a0</span> <span class="nb">append</span> <span class="n">b0</span> <span class="nb">append</span> <span class="n">c0</span> <span class="nb">append</span> <span class="n">d0</span> <span class="c1">//(Output is in little-endian)</span>

<span class="c1">//leftrotate function definition</span>
<span class="n">leftrotate</span> <span class="p">(</span><span class="n">x</span><span class="o">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span> <span class="n">binary</span> <span class="k">or</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="n">c</span><span class="p">))</span><span class="o">;</span></code></pre></div>

<p>The first decision to be made is what parts of the algorithm will be
implemented on the FPGA and what will be done in the control code.
In general, computations with simple control flow that are repeated over and
over again are a good fit for the FPGA. It’s also difficult to get FPGAs to
handle data that can be variable in size. Therefore, we will implement the
main loop, which processes a 512-bit chunk of the input, in Verilog.
The CPU control code can then take care of appropriately padding the input
and feeding it in chunk-by-chunk to the FPGA.</p>

<p>Now that we have decided <em>what</em> to implement, we must figure out how to break
the computation up into blocks, which can then be implemented as Verilog
separate modules.</p>

<p>First, it’s clear that we will need ROMs for <code>K</code> and <code>s</code>, as well as a RAM
for the input <code>M</code>. We will also need a module to compute <code>F</code>, a unit to compute
<code>g</code>, a left rotater, a 32-bit adder, and finally a state machine to make sure
the computatation proceeds in the correct order.</p>

<h2 id="implementing-memories">Implementing Memories</h2>

<p>The Cyclone V can efficiently implement small memories using on-chip block RAM.
In order to generate ROMs and RAMs that use the block RAM, we will use the
Altera MegaWizard tool.</p>

<p>To open MegaWizard, go to “Tools” -&gt; “MegaWizard Plug-In Manager”. This will
allow you to pick from a list of “megafunctions”, which are configurable
hardware IP blocks that can be added to a design. Right now, we are interested
in the megafunctions in the “Memory Compiler” section.</p>

<p>FPGA block RAM can have two separate sets of address and data signals.
Since we will be instantiating several many copies of our MD5 unit, it makes
sense to have them share memory as much as possible, so we will use the 2-port
ROM for <code>K</code> and <code>s</code>. In the first options page, select “64” for the number of
words in the memory. Then choose the correct word size. This should be 32 for
<code>K</code> and 5 for <code>s</code>. For “What should the memory block type be”, choose “M10K”.
You can skip the section on clocks, since the defaults there are fine.
On the third page, it will ask you which ports you want to put registers on.
The registers on the inputs are required, but the registers on the output ports
are optional. Each set of registers adds a cycle of delay, so deselect placing
registers on the outputs so that the ROM has only a single cycle delay.
On the fourth page, it will ask you to provide a file which specifies what
values will be in the ROM. You can choose to provide either a
<a href="http://quartushelp.altera.com/13.0/mergedProjects/reference/glossary/def_mif.htm">Memory Initialization File</a>
(.mif) or an <a href="https://en.wikipedia.org/wiki/Intel_HEX">Intel hex file</a>
(.hex). The former is more human-readable, while the latter can be more easily
computer-generated. You can find the .mif files for the <a href="https://github.com/zhemao/md5cracker/blob/master/romdata/kdata.mif">K ROM</a>
and <a href="https://github.com/zhemao/md5cracker/blob/master/romdata/sdata.mif">s ROM</a>
in the Github repository. After you’ve finished memory intialization, you can
click “Finish” to generate the Verilog modules for the memory.</p>

<p>You can follow the same procedure to generate the RAM for <code>M</code>. Choose the
2-port RAM in the “Memory Compiler” section. Create a RAM with one read port
and one write port. The wizard for RAMs has an extra section asking you what
should happen if you try to read from an address that is being written.
Choose “I do not care” for this. Also, for RAMs, you do not have to specify
a memory initialization file.</p>

<h2 id="combinational-units">Combinational Units</h2>

<p>Now that we have our memories, we can look at the combinational logic portions
of our circuit. First, let’s consider the computation for the <code>F</code> variable.
The <code>F</code> signal is generated from bitwise combinations of <code>B</code>, <code>C</code>, and <code>D</code>.
However, the particular operation depends on the value of the 6-bit loop
counter <code>i</code>. You will notice, however, that the only information we need is
whether it is in one of four equally sized ranges. We can determine this by
examining only the top two bits of <code>i</code>.</p>

<div class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">fcalc</span> <span class="p">(</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">sel</span><span class="p">,</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">b</span><span class="p">,</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">c</span><span class="p">,</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">d</span><span class="p">,</span>
    <span class="k">output</span> <span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">f</span>
<span class="p">);</span>

<span class="k">always</span> <span class="p">@(</span><span class="o">*</span><span class="p">)</span> <span class="k">begin</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">sel</span><span class="p">)</span>
        <span class="c1">// 0 &lt;= i &lt;= 15</span>
        <span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">d</span><span class="p">);</span>
        <span class="c1">// 16 &lt;= i &lt;= 31</span>
        <span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">c</span><span class="p">);</span>
        <span class="c1">// 32 &lt;= i &lt;= 47</span>
        <span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">b</span> <span class="o">^</span> <span class="n">c</span> <span class="o">^</span> <span class="n">d</span><span class="p">;</span>
        <span class="c1">// 48 &lt;= i &lt;= 63</span>
        <span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">^</span> <span class="p">(</span><span class="n">b</span> <span class="o">|</span> <span class="o">~</span><span class="n">d</span><span class="p">);</span>
    <span class="k">endcase</span>
<span class="k">end</span>

<span class="k">endmodule</span></code></pre></div>

<p>The <code>&amp;</code>, <code>|</code>, <code>^</code>, and <code>~</code> operators are bitwise AND, OR, XOR, and NOT
operations, respectively.</p>

<p>To compute <code>g</code>, we have to mutltiply <code>i</code> by certain constants, add it to
certain constants, and then take the result modulo 16. We can simplify this
by noting that taking the modulus of a binary integer by 16 is the same as
taking the lowest four bits. We can also simplify our logic based on the
fact that</p>

<pre><code>a * i + b == a * (i % 16) + b (mod 16)
</code></pre>

<p>That is, multiplying and adding based on the last four bits of <code>i</code> and then
taking the last four bits of the result is the same as multiplying and adding
by all six bits of <code>i</code>.</p>

<p>The final trick we can use is to get rid of multiplication, which is an
expensive logic operation. What you will notice is that the constants
we are multiplying by (3, 5, and 7) are all one away from a power of two
(2, 4, and 8). This is very convenient, since we can easily multiply by powers
of two by left shifting bits. We can then add or subtract the original number
from the shifted number to get the final result of the “multiplication”.
Therefore, we can express our multiplications using the following equivalents.</p>

<pre><code>3 * i = 2 * i + i = i &lt;&lt; 1 + i
5 * i = 4 * i + i = i &lt;&lt; 2 + i
7 * i = 8 * i - i = i &lt;&lt; 3 - i
</code></pre>

<p>The amount by which we shift <code>i</code> and the number we add to it will be selected
based on the two highest bits of <code>i</code>, just as we did with the <code>F</code> calculator.</p>

<div class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">gcalc</span> <span class="p">(</span>
    <span class="k">input</span>  <span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">i</span><span class="p">,</span>
    <span class="k">output</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">g</span>
<span class="p">);</span>

<span class="kt">reg</span> <span class="n">doshift</span><span class="p">;</span>
<span class="kt">reg</span> <span class="n">sub</span><span class="p">;</span>
<span class="kt">reg</span>  <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">shiftby</span><span class="p">;</span>
<span class="kt">reg</span>  <span class="p">[</span><span class="mh">2</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">addon</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">shift_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">doshift</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">shiftby</span> <span class="o">:</span> <span class="mh">4</span><span class="mb">&#39;b0</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mult_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span><span class="p">)</span> <span class="o">?</span> <span class="n">shift_res</span> <span class="o">-</span> <span class="n">i</span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="o">:</span> <span class="n">shift_res</span> <span class="o">+</span> <span class="n">i</span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span> <span class="n">g</span> <span class="o">=</span> <span class="n">mult_res</span> <span class="o">+</span> <span class="n">addon</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@(</span><span class="o">*</span><span class="p">)</span> <span class="k">begin</span>
    <span class="k">case</span> <span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">4</span><span class="p">])</span>
        <span class="c1">// 0 &lt;= i &lt;= 15</span>
        <span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span> <span class="k">begin</span>
            <span class="c1">// g = i</span>
            <span class="n">doshift</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
            <span class="n">sub</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
            <span class="n">shiftby</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b0</span><span class="p">;</span>
            <span class="n">addon</span> <span class="o">&lt;=</span> <span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
        <span class="k">end</span>
        <span class="c1">// 16 &lt;= i &lt;= 31</span>
        <span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span> <span class="k">begin</span>
            <span class="c1">// g = 5 * i + 1</span>
            <span class="n">doshift</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
            <span class="n">sub</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
            <span class="n">shiftby</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span>
            <span class="n">addon</span> <span class="o">&lt;=</span> <span class="mh">3</span><span class="mi">&#39;d1</span><span class="p">;</span>
        <span class="k">end</span>
        <span class="c1">// 32 &lt;= i &lt;= 47</span>
        <span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span> <span class="k">begin</span>
            <span class="c1">// g = 3 * i + 5</span>
            <span class="n">doshift</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
            <span class="n">sub</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b0</span><span class="p">;</span>
            <span class="n">shiftby</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
            <span class="n">addon</span> <span class="o">&lt;=</span> <span class="mh">3</span><span class="mi">&#39;d5</span><span class="p">;</span>
        <span class="k">end</span>
        <span class="c1">// 48 &lt;= i &lt;= 63</span>
        <span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span> <span class="k">begin</span>
            <span class="c1">// g = 7 * i</span>
            <span class="n">doshift</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
            <span class="n">sub</span> <span class="o">&lt;=</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
            <span class="n">shiftby</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">;</span>
            <span class="n">addon</span> <span class="o">&lt;=</span> <span class="mh">3</span><span class="mi">&#39;d0</span><span class="p">;</span>
        <span class="k">end</span>
    <span class="k">endcase</span>
<span class="k">end</span>

<span class="k">endmodule</span></code></pre></div>

<p>Then there is the left rotater, which is fairly straightforward. To express
a left rotation in verilog, you can double the input, left shift it, and
then take the top half of the bits.</p>

<div class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">leftrotate</span> <span class="p">(</span>
    <span class="k">input</span>  <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">rotin</span><span class="p">,</span>
    <span class="k">input</span>  <span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">rotby</span><span class="p">,</span>
    <span class="k">output</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">rotout</span>
<span class="p">);</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">rotmid</span> <span class="o">=</span> <span class="p">({</span><span class="n">rotin</span><span class="p">,</span> <span class="n">rotin</span><span class="p">}</span> <span class="o">&lt;&lt;</span> <span class="n">rotby</span><span class="p">);</span>
<span class="k">assign</span> <span class="n">rotout</span> <span class="o">=</span> <span class="n">rotmid</span><span class="p">[</span><span class="mh">63</span><span class="o">:</span><span class="mh">32</span><span class="p">];</span>

<span class="k">endmodule</span></code></pre></div>

<p>For the adder, we will simply use the verilog <code>+</code> operator. Now that we have
our combinational units, we will need to tie them together to perform the
inner loop of the computation.</p>

<h2 id="sequential-computation">Sequential Computation</h2>

<p>Stateless combinational logic is not enough to perform the computation we
want. Therefore, we will need a state machine to store intermediate results
in registers and select the correct inputs for the combinational units.
In the body of the inner loop of the MD5 algorithm, there are a lot of 32-bit
additions. However, we would like to reduce the number of 32-bit adders we
use so as not to use too many logic elements. Fortunately, through clever
sequencing, there is a way to do the computation in just four cycles using
only one 32-bit adder.</p>

<pre><code>Step 0
    calculate F
    calculate g
    t0 = A + K[i]
Step 1
    t1 = F + M[g]
Step 2
    t0 = t0 + t1
Step 3
    A = D
    B = B + leftrotate(t0, s[i])
    C = B
    D = C
    i = i + 1
</code></pre>

<p>These four steps will have to be repeated 64 times, with i incrementing each
time. Then, at the end, we will need four more cycles to add A, B, C, and D
onto a0, b0, c0, and d0.</p>

<div class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">chunk_cruncher</span> <span class="p">(</span>
    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
    <span class="k">input</span> <span class="n">reset</span><span class="p">,</span>
    <span class="k">input</span> <span class="n">start</span><span class="p">,</span>
    <span class="k">output</span> <span class="n">done</span><span class="p">,</span>

    <span class="k">output</span> <span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">digest</span><span class="p">,</span>

    <span class="k">output</span> <span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">iaddr</span><span class="p">,</span>
    <span class="k">input</span>  <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">kdata</span><span class="p">,</span>
    <span class="k">input</span>  <span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">sdata</span><span class="p">,</span>

    <span class="k">output</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">gaddr</span><span class="p">,</span>
    <span class="k">input</span>  <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">mdata</span>
<span class="p">);</span>

<span class="k">parameter</span> <span class="no">INITA</span> <span class="o">=</span> <span class="mh">32&#39;h67452301</span><span class="p">;</span>
<span class="k">parameter</span> <span class="no">INITB</span> <span class="o">=</span> <span class="mh">32&#39;hefcdab89</span><span class="p">;</span>
<span class="k">parameter</span> <span class="no">INITC</span> <span class="o">=</span> <span class="mh">32&#39;h98badcfe</span><span class="p">;</span>
<span class="k">parameter</span> <span class="no">INITD</span> <span class="o">=</span> <span class="mh">32&#39;h10325476</span><span class="p">;</span>

<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">a0</span><span class="p">;</span>
<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">b0</span><span class="p">;</span>
<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">c0</span><span class="p">;</span>
<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">d0</span><span class="p">;</span>

<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">areg</span><span class="p">;</span>
<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">breg</span><span class="p">;</span>
<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">creg</span><span class="p">;</span>
<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">dreg</span><span class="p">;</span>

<span class="k">assign</span> <span class="n">digest</span> <span class="o">=</span> <span class="p">{</span><span class="n">d0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">a0</span><span class="p">};</span>

<span class="kt">reg</span> <span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">ireg</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">f</span><span class="p">;</span>
<span class="kt">reg</span>  <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">freg</span><span class="p">;</span>

<span class="kt">reg</span>  <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">adda</span><span class="p">;</span>
<span class="kt">reg</span>  <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">addb</span><span class="p">;</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">adds</span> <span class="o">=</span> <span class="n">adda</span> <span class="o">+</span> <span class="n">addb</span><span class="p">;</span>

<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">t0</span><span class="p">;</span>
<span class="kt">reg</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">t1</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">rotated</span><span class="p">;</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">inext</span> <span class="o">=</span> <span class="n">ireg</span> <span class="o">+</span> <span class="mh">1</span><span class="mb">&#39;b1</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">iaddr</span> <span class="o">=</span> <span class="n">ireg</span><span class="p">;</span>

<span class="n">fcalc</span> <span class="n">fc</span> <span class="p">(</span>
    <span class="p">.</span><span class="n">sel</span> <span class="p">(</span><span class="n">ireg</span><span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">4</span><span class="p">]),</span>
    <span class="p">.</span><span class="n">b</span> <span class="p">(</span><span class="n">breg</span><span class="p">),</span>
    <span class="p">.</span><span class="n">c</span> <span class="p">(</span><span class="n">creg</span><span class="p">),</span>
    <span class="p">.</span><span class="n">d</span> <span class="p">(</span><span class="n">dreg</span><span class="p">),</span>
    <span class="p">.</span><span class="n">f</span> <span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="p">);</span>

<span class="n">gcalc</span> <span class="n">gc</span> <span class="p">(</span>
    <span class="p">.</span><span class="n">i</span> <span class="p">(</span><span class="n">ireg</span><span class="p">),</span>
    <span class="p">.</span><span class="n">g</span> <span class="p">(</span><span class="n">gaddr</span><span class="p">)</span>
<span class="p">);</span>

<span class="n">leftrotate</span> <span class="n">lr</span> <span class="p">(</span>
    <span class="p">.</span><span class="n">rotin</span> <span class="p">(</span><span class="n">t0</span><span class="p">),</span>
    <span class="p">.</span><span class="n">rotby</span> <span class="p">(</span><span class="n">sdata</span><span class="p">),</span>
    <span class="p">.</span><span class="n">rotout</span> <span class="p">(</span><span class="n">rotated</span><span class="p">)</span>
<span class="p">);</span>

<span class="k">parameter</span> <span class="no">CRUNCH</span>   <span class="o">=</span> <span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
<span class="k">parameter</span> <span class="no">FINALIZE</span> <span class="o">=</span> <span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
<span class="k">parameter</span> <span class="no">FINISHED</span> <span class="o">=</span> <span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span>

<span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">stage</span><span class="p">;</span>

<span class="k">assign</span> <span class="n">done</span> <span class="o">=</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="no">FINISHED</span><span class="p">);</span>

<span class="kt">reg</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">step</span><span class="p">;</span>

<span class="k">always</span> <span class="p">@(</span><span class="o">*</span><span class="p">)</span> <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="no">CRUNCH</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">areg</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">kdata</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">freg</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">mdata</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">t0</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">t1</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">breg</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">rotated</span><span class="p">;</span>
            <span class="k">end</span>
        <span class="k">endcase</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="no">FINALIZE</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">a0</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">areg</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">b0</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">breg</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">c0</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">creg</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">adda</span> <span class="o">&lt;=</span> <span class="n">d0</span><span class="p">;</span>
                <span class="n">addb</span> <span class="o">&lt;=</span> <span class="n">dreg</span><span class="p">;</span>
            <span class="k">end</span>
        <span class="k">endcase</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
        <span class="n">adda</span> <span class="o">&lt;=</span> <span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
        <span class="n">addb</span> <span class="o">&lt;=</span> <span class="mh">32</span><span class="mi">&#39;d0</span><span class="p">;</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">always</span> <span class="p">@(</span><span class="k">posedge</span> <span class="n">clk</span><span class="p">)</span> <span class="k">begin</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="k">begin</span>
        <span class="n">a0</span> <span class="o">&lt;=</span> <span class="no">INITA</span><span class="p">;</span>
        <span class="n">b0</span> <span class="o">&lt;=</span> <span class="no">INITB</span><span class="p">;</span>
        <span class="n">c0</span> <span class="o">&lt;=</span> <span class="no">INITC</span><span class="p">;</span>
        <span class="n">d0</span> <span class="o">&lt;=</span> <span class="no">INITD</span><span class="p">;</span>
        <span class="n">ireg</span> <span class="o">&lt;=</span> <span class="mh">6</span><span class="mi">&#39;d00</span><span class="p">;</span>
        <span class="n">stage</span> <span class="o">&lt;=</span> <span class="no">FINISHED</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">begin</span>
        <span class="n">areg</span> <span class="o">&lt;=</span> <span class="n">a0</span><span class="p">;</span>
        <span class="n">breg</span> <span class="o">&lt;=</span> <span class="n">b0</span><span class="p">;</span>
        <span class="n">creg</span> <span class="o">&lt;=</span> <span class="n">c0</span><span class="p">;</span>
        <span class="n">dreg</span> <span class="o">&lt;=</span> <span class="n">d0</span><span class="p">;</span>
        <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
        <span class="n">stage</span> <span class="o">&lt;=</span> <span class="no">CRUNCH</span><span class="p">;</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="no">CRUNCH</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">freg</span> <span class="o">&lt;=</span> <span class="n">f</span><span class="p">;</span>
                <span class="c1">// t0 = areg + kdata</span>
                <span class="n">t0</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span> <span class="k">begin</span>
                <span class="c1">// t1 = freg + mdata</span>
                <span class="n">t1</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span> <span class="k">begin</span>
                <span class="c1">// t0 = t0 + t1</span>
                <span class="n">t0</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">;</span>
                <span class="n">ireg</span> <span class="o">&lt;=</span> <span class="n">inext</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span> <span class="k">begin</span>
                <span class="n">areg</span> <span class="o">&lt;=</span> <span class="n">dreg</span><span class="p">;</span>
                <span class="c1">// breg = breg + rotate(t0, sdata)</span>
                <span class="n">breg</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">creg</span> <span class="o">&lt;=</span> <span class="n">breg</span><span class="p">;</span>
                <span class="n">dreg</span> <span class="o">&lt;=</span> <span class="n">creg</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">ireg</span> <span class="o">!=</span> <span class="mh">6</span><span class="mi">&#39;d0</span><span class="p">)</span> <span class="k">begin</span>
                    <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
                <span class="k">end</span> <span class="k">else</span> <span class="k">begin</span>
                    <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b00</span><span class="p">;</span>
                    <span class="n">stage</span> <span class="o">&lt;=</span> <span class="no">FINALIZE</span><span class="p">;</span>
                <span class="k">end</span>
            <span class="k">end</span>
        <span class="k">endcase</span>
    <span class="k">end</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stage</span> <span class="o">==</span> <span class="no">FINALIZE</span><span class="p">)</span> <span class="k">begin</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">step</span><span class="p">)</span>
            <span class="mh">2</span><span class="mb">&#39;b00</span><span class="o">:</span> <span class="k">begin</span>
                <span class="c1">// a0 += areg</span>
                <span class="n">a0</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b01</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b01</span><span class="o">:</span> <span class="k">begin</span>
                <span class="c1">// b0 += breg</span>
                <span class="n">b0</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b10</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b10</span><span class="o">:</span> <span class="k">begin</span>
                <span class="c1">// c0 += creg</span>
                <span class="n">c0</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">step</span> <span class="o">&lt;=</span> <span class="mh">2</span><span class="mb">&#39;b11</span><span class="p">;</span>
            <span class="k">end</span>
            <span class="mh">2</span><span class="mb">&#39;b11</span><span class="o">:</span> <span class="k">begin</span>
                <span class="c1">// d0 += dreg</span>
                <span class="n">d0</span> <span class="o">&lt;=</span> <span class="n">adds</span><span class="p">;</span>
                <span class="n">stage</span> <span class="o">&lt;=</span> <span class="no">FINISHED</span><span class="p">;</span>
            <span class="k">end</span>
        <span class="k">endcase</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="k">endmodule</span></code></pre></div>

<p>This <code>chunk_cruncher</code> module performs the computation in the inner loop of
the MD5 algorithm. It has address and data ports for the ROMs and RAMs,
as well as reset and start signals. The reset signal will tell the unit to
begin a new MD5 calculation, and the start signal will tell the unit to process
a new 512-bit chunk.</p>

<p>The first <code>always</code> block is combinational and simply multiplexes the inputs
of the 32-bit adder based on the current step and stage. The second <code>always</code>
block is our state machine.</p>

<p>Note that, oddly enough, we do <code>i = i + 1</code> in step 2 instead of step 3.
This is because there are registers on the address inputs of our ROMs.
We change the value of <code>i</code> in step 2. In step 3, the value of <code>s</code> will be based
on the old value of <code>i</code>. Then, when we wrap around back to step 0, the value
of <code>k</code> will be based on the new value of <code>i</code>.</p>

<h2 id="putting-memory-and-computation-together">Putting Memory and Computation Together</h2>

<p>Now that we have our memory and computational blocks, we’ll have to put them
together in order to make them do something useful. Since our ROMs are dual
ported, we’ll put together two “chunk_cruncher” modules, an sdata ROM, a kdata
ROM, and two mdata RAMs.</p>

<div class="highlight"><pre><code class="language-verilog" data-lang="verilog"><span class="k">module</span> <span class="n">md5unit</span> <span class="p">(</span>
    <span class="k">input</span> <span class="n">clk</span><span class="p">,</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">reset</span><span class="p">,</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">start</span><span class="p">,</span>

    <span class="k">input</span> <span class="n">write</span><span class="p">,</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">writedata</span><span class="p">,</span>
    <span class="k">input</span> <span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">writeaddr</span><span class="p">,</span>

    <span class="k">output</span> <span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">digest0</span><span class="p">,</span>
    <span class="k">output</span> <span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">digest1</span><span class="p">,</span>

    <span class="k">output</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">done</span>
<span class="p">);</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">m_write</span><span class="p">;</span>
<span class="k">assign</span> <span class="n">m_write</span><span class="p">[</span><span class="mh">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">writeaddr</span><span class="p">[</span><span class="mh">4</span><span class="p">];</span>
<span class="k">assign</span> <span class="n">m_write</span><span class="p">[</span><span class="mh">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">write</span> <span class="o">&amp;&amp;</span> <span class="n">writeaddr</span><span class="p">[</span><span class="mh">4</span><span class="p">];</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">5</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">cc_iaddr</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">cc_gaddr</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">127</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">cc_digest</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span> <span class="n">digest0</span> <span class="o">=</span> <span class="n">cc_digest</span><span class="p">[</span><span class="mh">0</span><span class="p">];</span>
<span class="k">assign</span> <span class="n">digest1</span> <span class="o">=</span> <span class="n">cc_digest</span><span class="p">[</span><span class="mh">1</span><span class="p">];</span>

<span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">cc_mdata</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">4</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span>  <span class="n">cc_sdata</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>
<span class="kt">wire</span> <span class="p">[</span><span class="mh">31</span><span class="o">:</span><span class="mh">0</span><span class="p">]</span> <span class="n">cc_kdata</span> <span class="p">[</span><span class="mh">1</span><span class="o">:</span><span class="mh">0</span><span class="p">];</span>

<span class="k">genvar</span> <span class="n">i</span><span class="p">;</span>
<span class="k">generate</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mh">1</span><span class="p">)</span> <span class="k">begin</span> <span class="o">:</span> <span class="n">mccgen</span>
        <span class="n">chunk_cruncher</span> <span class="n">cc</span> <span class="p">(</span>
            <span class="p">.</span><span class="n">clk</span> <span class="p">(</span><span class="n">clk</span><span class="p">),</span>
            <span class="p">.</span><span class="n">reset</span> <span class="p">(</span><span class="n">reset</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">start</span> <span class="p">(</span><span class="n">start</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">done</span> <span class="p">(</span><span class="n">done</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">digest</span> <span class="p">(</span><span class="n">cc_digest</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">iaddr</span> <span class="p">(</span><span class="n">cc_iaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">kdata</span> <span class="p">(</span><span class="n">cc_kdata</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">sdata</span> <span class="p">(</span><span class="n">cc_sdata</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">gaddr</span> <span class="p">(</span><span class="n">cc_gaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">mdata</span> <span class="p">(</span><span class="n">cc_mdata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">);</span>

        <span class="n">mdataram</span> <span class="n">mram</span> <span class="p">(</span>
            <span class="p">.</span><span class="n">clock</span> <span class="p">(</span><span class="n">clk</span><span class="p">),</span>
            <span class="p">.</span><span class="n">data</span> <span class="p">(</span><span class="n">writedata</span><span class="p">),</span>
            <span class="p">.</span><span class="n">wraddress</span> <span class="p">(</span><span class="n">writeaddr</span><span class="p">[</span><span class="mh">3</span><span class="o">:</span><span class="mh">0</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">wren</span> <span class="p">(</span><span class="n">m_write</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">rdaddress</span> <span class="p">(</span><span class="n">cc_gaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
            <span class="p">.</span><span class="n">q</span> <span class="p">(</span><span class="n">cc_mdata</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="p">);</span>
    <span class="k">end</span>
<span class="k">endgenerate</span>

<span class="n">sdatarom</span> <span class="n">srom</span> <span class="p">(</span>
    <span class="p">.</span><span class="n">clock</span> <span class="p">(</span><span class="n">clk</span><span class="p">),</span>
    <span class="p">.</span><span class="n">address_a</span> <span class="p">(</span><span class="n">cc_iaddr</span><span class="p">[</span><span class="mh">0</span><span class="p">]),</span>
    <span class="p">.</span><span class="n">address_b</span> <span class="p">(</span><span class="n">cc_iaddr</span><span class="p">[</span><span class="mh">1</span><span class="p">]),</span>
    <span class="p">.</span><span class="n">q_a</span> <span class="p">(</span><span class="n">cc_sdata</span><span class="p">[</span><span class="mh">0</span><span class="p">]),</span>
    <span class="p">.</span><span class="n">q_b</span> <span class="p">(</span><span class="n">cc_sdata</span><span class="p">[</span><span class="mh">1</span><span class="p">])</span>
<span class="p">);</span>

<span class="n">kdatarom</span> <span class="n">krom</span> <span class="p">(</span>
    <span class="p">.</span><span class="n">clock</span> <span class="p">(</span><span class="n">clk</span><span class="p">),</span>
    <span class="p">.</span><span class="n">address_a</span> <span class="p">(</span><span class="n">cc_iaddr</span><span class="p">[</span><span class="mh">0</span><span class="p">]),</span>
    <span class="p">.</span><span class="n">address_b</span> <span class="p">(</span><span class="n">cc_iaddr</span><span class="p">[</span><span class="mh">1</span><span class="p">]),</span>
    <span class="p">.</span><span class="n">q_a</span> <span class="p">(</span><span class="n">cc_kdata</span><span class="p">[</span><span class="mh">0</span><span class="p">]),</span>
    <span class="p">.</span><span class="n">q_b</span> <span class="p">(</span><span class="n">cc_kdata</span><span class="p">[</span><span class="mh">1</span><span class="p">])</span>
<span class="p">);</span>

<span class="k">endmodule</span></code></pre></div>

<h2 id="conclusion">Conclusion</h2>

<p>So now we’ve built are MD5 unit. But how do we make sure it works? In my next
post, I’ll discuss verification using the ModelSim circuit simulator.</p>

<p><a href="../../../2013/12/29/sockit-4.html">&lt;- Part 4</a>
<a href="../06/sockit-6.html">Part 6 -&gt;</a></p>

</div> <!--main-->

</div> <!--container-->
</body>
</html>
